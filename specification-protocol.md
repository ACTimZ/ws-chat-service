# Спецификация протокола WebSocket для сервиса "Чат в реальном времени"

**1. Формат сообщений:**
- Все сообщения между клиентом и сервером передаются в формате JSON

---

**2. Типы событий (поле "type"):**
    - `join` — пользователь входит в комнату
    - `message` — пользователь отправляет текстовое сообщение в комнату
    - `leave` — пользователь покидает комнату

---

**3. Структура сообщений:**
1. Вход в комнату (`join`)
   - Обязательные поля:
     - `type`: "join"
     - `username`: строка (имя пользователя)
     - `room`: строка (название комнаты)

    **Пример:**
    ```json
    {
        "type": "join",
        "username": "Elon",
        "room": "rooma1"
    }
    ```

2. Отправка сообщения (`message`)
   - Обязательные поля:
     - `type`: "message"
     - `username`: строка
     - `room`: строка
     - `message`: строка (текст сообщения)

    **Пример:**
    ```json
    {
        "type": "message",
        "username": "Elon",
        "room": "rooma1",
        "message": "I'm Elon Musk!"
    }
    ```

3. Выход из комнаты (`leave`)
   - Обязательные поля:
     - `type`: "leave"
     - `username`: строка
     - `room`: строка

    **Пример:**
    ```json
    {
        "type": "leave",
        "username": "Elon",
        "room": "rooma1"
    }
    ```

4. Системные сообщения (`system`)
   - Используются сервером для оповещения других участников комнаты о событиях (вход/выход);
   - Поля:
     - `type`: "system"
     - `message`: строка (текст уведомления)

    **Пример:**
    ```json
    {
        "type": "system",
        "message": "Пользователь Elon вошёл в комнату \"rooma1\""
    }
    ```

5. Сообщения об ошибках (`error`)
   - Используются сервером для информирования клиента о некорректных действиях;
   - Поля:
     - `type`: "error"
     - `message`: строка (описание ошибки)

    **Пример:**
    ```json
    {
        "type": "error",
        "message": "Ошибка валидации: Вы не указали поле \"type\""
    }
    ```

---

**4. Валидация и обработка ошибок:**
- Все обязательные поля должны присутствовать и быть корректного типа;
- Если тип события не входит в список допустимых (`join`, `leave`, `message`), сервер возвращает сообщение с `type: "error"` и описанием ошибки в терминал;
- Если отсутствует обязательное поле (`username`, `room`, для `message` — ещё и `message`), сервер возвращает сообщение с `type: "error"` и логированием в терминал;
- Если сообщение не является валидным JSON, сервер возвращает сообщение с `type: "error"` и текстом "Неверный JSON" в терминал;
- При ошибках аутентификации соединение закрывается с соответствующим кодом (4001 и пр.) и причиной.

---

**5. Сценарии обмена:**
1. Клиент подключается к серверу с JWT-токеном (query-параметр в url под ключом `token` и с соответствующим значением полученного токена);
2. После успешного подключения клиент отправляет сообщение с `type: "join"`;
3. Сервер оповещает других участников комнаты системным сообщением, что некоторый пользователь вошёл в комнату (`type: "system"`);
4. Пользователь отправляет сообщения с `type: "message"` и они рассылаются всем участникам комнаты;
5. При выходе пользователя отправляется сообщение с `type: "leave"` и, как следствие, остальные получают уведомление, что некоторый пользователь вышел из комнаты и/или отключился (`type: "system"`);
6. При ошибках валидации или формате сервер отправляет сообщение с `type: "error"`.

---

**6. Пример обмена:**
1. Клиент -> Сервер:
```json
{
    "type": "join",
    "username": "Elon",
    "room": "rooma1"
}
```

2. Сервер -> Все в комнате (кроме Elon):
```json
{
    "type": "system",
    "message": "Пользователь Elon вошёл в комнату \"rooma1\""
}
```

3. Клиент -> Сервер:
```json
{
    "type": "message",
    "username": "Elon",
    "room": "rooma1",
    "message": "I'm Elon Musk!"
}
```

4. Сервер -> Все в комнате:
```json
{
    "type": "message",
    "username": "Elon",
    "message": "I'm Elon Musk!"
}
```

5. Клиент -> Сервер:
```json
{
    "type": "leave",
    "username": "Elon",
    "room": "rooma1"
}
```

6. Сервер -> Все в комнате (кроме Elon):
```json
{
    "type": "system",
    "message": "Пользователь Elon покинул комнату"
}
```

---

## Примечания:
- Сервер автоматически удаляет неактивные соединения (пинг и понг);
- Все сообщения между клиентом и сервером передаются в формате JSON;
- Тестирование сервиса можно также проводить в ПО "Postman", выбрав "WebSocket" в качестве типа соединения и указав адрес сервера. И отправлять тем самым сообщения в формате JSON.